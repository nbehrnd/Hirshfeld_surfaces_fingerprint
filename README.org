
# name:    README.org
# author:  Norwid Behrnd
# license: GPLv2
# edit:    2019-12-16 (YYYY-MM-DD)

#+OPTIONS: toc:nil

#+LATEX_CLASS:    koma-article  
#+LATEX_HEADER:   \usepackage[a4paper]{geometry}
#+LATEX_HEADER:   \usepackage{libertine, microtype, graphicx, float}
#+LATEX_HEADER:   \usepackage[USenglish]{babel}
#+LATEX_HEADER:   \usepackage[scaled=0.9]{inconsolata}
#+LATEX_HEADER:   \usepackage[libertine]{newtxmath}

#+LATEX_HEADER:   \setkomafont{captionlabel}{\sffamily\bfseries}
#+LATEX_HEADER:   \setcapindent{0em}  \setkomafont{caption}{\small}


* Background

  Reading crystallographic models as =*.cif= file,
  CrystalExplorer[fn:1] is capable to assess the electronic
  interactions of a molecule with its surrounding crystal.  This is
  visualized with Hirshfeld surfaces,[fn:2] and may be projected as a
  2D fingerprint map.[fn:3]

  Carter /et al./ suggest the inspection of /the differences/ of these
  2D fingerprint maps[fn:4] to ease discern of similarities and
  differences when comparing these fingerprints: Contrasting to a
  qualitative discern of the maps (e.g. =compare= by
  ImageMagick),[fn:5] this approach allows both a visual as well as
  numeric quantification of the differences.  This is illustrated
  below with the example of two crystallographic model data describing
  two polymorphs of benzamide (fig. [[alignment]]).  The scope of this
  analysis may be extended to iso-structural materials, too.
  #+NAME:    alignment
  #+CAPTION: 2D fingerprint maps of Hirshfeld surfaces for CCDC model BZAMID01 and BZAMID11 (left and left center), derived from the analysis by CrystalExplorer at /very high/ resolution (d_e and d_i in the range of 0.40--3.00 \AA, with a 0.01 \AA increment in the plane).  Qualitative difference assignment by superposition as provided by ImageMagick (right center), red pixels indicate difference between the two images inspected.  Simultaneous qualitative and quantitative spatial information provided by the /difference map/ generated with the scripts of this repository.
  #+ATTR_LATEX: :width 15cm
  #+ATTR_HTML:  :width 75%
  [[./doc_support/alignment_normal.png]]


* Basic use

  The following sequence describes the analysis of the two benzamide
  model data on Linux Xubuntu 18.04.3LTS with CrystalExplorer
  (version 17.5).  The results of computation were visualized with
  =gnuplot= (version 5.2.7beta).

  + By default CrystalExplorer removes intermediate working files,
    including the =.csx= this analysis requires.  To retain this
    information, access the preferences menu (File -> Preferences) and
    uncheck the corresponding entry located under the expert tab. Now
    close the preference menu and load the =*.cif= file in question.
    Compute the Hirshfeld surface at /very high/ resolution (i.e., one
    level higher than by default).

  + The =*.cxs= files generated by CrystalExplorer are to be
    normalized by =fingerprint.90=, requiring a compiler such as
    =gfortran=[fn:12] or =gcc=[fn:7] to compile an executable by
    #+BEGIN_SRC shell
      gfortran fingerprint.f90 -o fingerprint.x
    #+END_SRC
    and subsequently deployed in a a pattern of 
    #+BEGIN_SRC shell
      ./fingerprint.x  input.cxs [standard | translated | extended] output.dat
    #+END_SRC
    with =standard=, =translated=, or =extended= as three, mutually
    excluding map ranges to consider ([0.4,2.6], [0.8,3.0], or
    [0.4,3.0] \AA) for the normalized 2D fingerprint map deposit in
    file =output.dat=.

    The computation of the /difference map/ of 2D fingerprints
    requires =diff_finger.c= to be compiled, e.g. with =gcc=[fn:7] by
    #+BEGIN_SRC shell
    gcc diff_finger.c -o diff_finger
    #+END_SRC
    and the subsequent deployment of the executable in a pattern of
    #+BEGIN_SRC shell
      ./diff_finger input_A.dat input_B.dat > difference.dat
    #+END_SRC
    to compute the difference map deposit in =difference.dat=.

    Requiring an installation of Ruby, these difference maps may be
    condensed to a single figure by a call of
    #+BEGIN_SRC shell
    ruby sum_abs_diffs.rb difference.dat
    #+END_SRC
    which is print on the CLI.

    Sub-folder =plot2gnuplot= contains =bash= scripts to facilitate
    the /visual inspection/ of either 2D fingerprint, or difference
    map with gnuplot[fn:10] if called in a pattern like
    #+BEGIN_SRC shell 
      ./plot_finger_png.sh BZAMID01.dat
    #+END_SRC
    As indicated in the file names of these =bash= scripts, the output
    format of the plots generated by =gnuplot= is either bitmap
    =*.png=, or resolution independent =*.pdf=.  Possibly, they
    require provision of the executable bit by (=chmod u+x
    example.sh=) to work after check-out.

  + Starting with this release, Python script =Hirshfeld_moderator.py=
    is set up to facilitate the interaction with the =*.cxs= files in
    Linux.  Its /help/ menu is invoked by
    #+BEGIN_SRC shell
    python3 Hirshfeld_moderator.py -h
    #+END_SRC

    After putting the scripts =Hirshfeld_moderator.py=,
    =fingerprint.f90= and =diff_finger.c= into the root of the
    project, the suggested sequence to work with this wrapper is to
    /list/ (toggle =-l=), then to /copy/ (toggle =-c=) the =*.cxs=
    into a dedicated sub-folder, =cxs_workshop=.  The two operations
    retrieve the raw data =*.cxs= either in the same root folder as
    the current working directory, or in sub-folders to the current
    work directory.  If present, the file names of =*.cxs= files
    /already copied to =cxs_workshop=/ are automatically truncated at
    first underscore.

    The /normalization/ of the =*.cxs= yielding 2D fingerprint =*.dat=
    files (extended map range) is invoked by the toggle =-n=.  The
    script stops at this level if either the source code,
    =fingerprint.f90=, is missing; or if the compilation with either
    =gfortan= (default), or =gcc= (backup solution) fails.

    The /computation of difference maps/ is launched by toggle =-c=
    with all 2D fingerprint maps identified in sub-folder
    =cxs_workshop=.  Again, the moderator script will halt the
    execution if either the source code, =diff_finger.c= is missing,
    or if the compilation of the source code (=gcc=) fails.  The
    difference maps are stored in =diff*.dat= files.

    Assuming a callable installation of ruby, toggle =-r= will
    determine the /ruby difference number/ on all difference maps in
    =cxs_workshop=.  The output on the CLI may be redirected into a
    permanent record, e.g. by
    #+BEGIN_SRC shell
      python3 Hirshfeld_moderator.py -r > report.txt
    #+END_SRC
    The absence of ruby will not affect other stages of the analysis.

  + The visual inspection of the results is relayed to gnuplot with
    third-party module =Gnuplot.py=, which freely is available e.g.,
    with =pip=.[fn:13]  To provide an initial /overview/, call
    #+BEGIN_SRC shell
      python3 Hirshfeld_moderator.py -o
    #+END_SRC
    The =.png= in low resolution and dimension are intended to decide
    if a display with the standard map range ([0.4,2.6] \AA, lower
    left square) or translated map range ([0.8,3.0] \AA, upper right
    square) may be more suitable than the current perspective in
    extended map range ([0.4,3.0] \AA).

    #+NAME:  provision_overview
    #+CAPTION:  Example survey of 2D fingerprint maps (left, centre) and difference map plot (right). Intended as guidance for setting up subsequent plots in high resolution, frames mark standard and translated map range, respectively by dashes (left, bottom) or dots (right, atop) while displaying the extended range.  The right bottom corner states the maximal and minimal /z/-value readout from the =.dat=.
    #+ATTR_LATEX:  :width 15cm
    #+ATTR_HTML:   :width 75%
    [[./doc_support/survey.png]]

    The source code by Paolo Raiteri and Andrew Rohl suggests to
    constrain the /z/-scale to [0,0.08] (2D fingerprint maps) and
    [-0.025:0.025] (difference maps).  Especially for the scrutiny of
    sets of Hirshfeld surface analyses, it may be particularly useful
    to adjust these limits for whole series.  It is for this reason
    the lowest and highest /z/-value in the =.dat= files are reported
    both in the images, as well as in a permanent record written,
    =gp_report.txt=.[fn:11]

  + The creation of high-resolution plots generates /either/ 2D
    /fingerprint/ or /difference maps/ in either =*.pdf= or =*.png=.
    This is concatenated in the instruction, e.g.,
    #+BEGIN_SRC shell
      python3 Hirshfeld_moderator --dpng e
    #+END_SRC
    to generate /difference maps/ as =*.png=.  If no parameter is
    given, the extended map range ([0.4,3.0] \AA) for d_e and d_i is
    assumed.  This is equivalent to the explicit provision of the =e=
    parameter as in the example above.  The selection of the standard
    map range ([0.4,2.6] \AA), or the translated map range
    ([0.8,3.0] \AA) instead require the provision of either =s= or =t=
    parameter.

  + Both types of representation in high resolution deploy /as
    adjustable default/ a /z/-range of [0.00,0.08] (2D fingerprint
    maps) and [-0.025,0.025] (difference maps).  It is optional to
    override these defaults in line of, e.g.
    #+BEGIN_SRC shell
      python3 Hirshfeld_moderator.py --dpng e --zmax 0.03
    #+END_SRC
    to limit the /z/-range of the difference map to [-0.03,0.03].

    To ease comparison across series of data, the highest and lowest
    /z/-value recorded in the =.dat= data will be displayed in the
    plot.

  + To ease the visual inspection, =Hirshfeld_moderator.py= may toggle
    the color palettes used by the optional toggle =-a=.  This then
    replaces palettes used for either fingerprint or difference map by
    palettes perceptually safer, e.g. for an output constrained to
    gray-scale.

    Equally optional, and independent of the color-palette selected,
    the high-resolution output may use a neuter gray background.  This
    is invoked by the optional toggle =-g=.

  Below, the effect of color palette and background selection is
  illustrated.  They each display the fingerprint about either CSD
  model =BZAMID01=, or =BZAMID11=; the difference plot for the two
  fingerprints as determined by ImageMagic's =compare=, and the
  computed difference map as displayed by gnuplot.
  
  #+NAME:    alignment_normal
  #+CAPTION: Gnuplot output of 2D fingerprint maps (very left, left centre), ImageMagick's difference (right centre) and gnuplot's difference map in default mode.
  #+ATTR_LATEX:  :width 15cm
  #+ATTR_HTML:  :width 75%
  [[./doc_support/alignment_normal.png]]

  #+NAME:  alignment_normal_gray
  #+CAPTION: Gnuplot output of 2D fingerprint maps (very left, left centre), ImageMagick's difference (right centre) and gnuplot's difference map with default palettes and optional neutral gray background.  
  #+ATTR_LATEX:  :width 15cm
  #+ATTR_HTML:  :width 75%
  [[./doc_support/alignment_normal_gray.png]]

  #+NAME:  alternate
  #+CAPTION: Gnuplot output of 2D fingerprint maps (very left, left centre), ImageMagick's difference (right centre) and gnuplot's difference map with alternate palettes.  
  #+ATTR_LATEX:  :width 15cm
  #+ATTR_HTML:  :width 75%
  [[./doc_support/alignment_alternate.png]]

  #+NAME:  alternate_gray
  #+CAPTION: Gnuplot output of 2D fingerprint maps (very left, left centre), ImageMagick's difference (right centre) and gnuplot's difference map with alternate palettes and gray background.
  #+ATTR_LATEX:  :width 15cm
  #+ATTR_HTML:  :width 75%
  [[./doc_support/alignment_alternate_gray.png]]

  Note that the output generated by gnuplot may be either =.png=
  (e.g., by invoking =--dpng e=), or resolution independent format
  =.pdf= (e.g., by invoking =--dpdf s=).  Thanks to gnuplot's
  /conditional plotting/[fn:8], the vector-based output tends to be
  less large than the bitmap.

* Footnotes

[fn:13] In preparation of this guide, =Gnuplot.py= in version 1.8 was
used successfully.

[fn:12] In preparation of this guide, =gfortran= in version 7.4.0 was
used successfully.

[fn:11] The entries may be sorted, e.g., by =sort -k4 -n input.txt -o
output.txt= as  =sort= is part of the GNU coreutils.

[fn:10] http://gnuplot.info

[fn:9] Note that if you would like to use these bash =.sh= scripts as
gnuplot =.plt= files, occasionally instructions like =\$= (with
backslash) escaping the shell need to be reset as =$= (without
backslash).

[fn:8] Thanks to Ethan Merrit who suggested this additional
improvement in a private communication.  Savings in file volume are
especially noticed for the generation of =*.pdf=.

[fn:7] In preparation of this guide, =gcc= in version 7.4.0 was used
successfully.

[fn:6] The script successfully works with gfortran (version 7.4.0).
The optimization of the executable (=-O= parameter) does not offer a
noticeable advantage if comparing a few model data.

[fn:5] https://imagemagick.org/ Within the bundle, the instruction
following the basic pattern of =compare image_A image_B= provides a
check.  Additional information on
https://imagemagick.org/script/compare.php.

[fn:4] "Difference Hirshfeld fingerprint plots: a tool for studying
polymorphs." Carter, D. J.; Raiteri, P.; Barnard, K. R.; Gielink, R.;
Mocerino, M.; Skelton, B. W.; Vaughan, J. G.; Ogden, M. I.; Rohl,
A. L. in CrystEngComm, 2017, 19, 2207--2215, DOI: [[https://pubs.rsc.org/en/content/articlelanding/2017/ce/c6ce02535h#!divAbstract][10.1039/c6ce02535h]].


[fn:3] "Fingerprinting Intermolecular Interactions in Molecular
Crystals", Spackman, M. A.; McKinnon, J. J. in CrystEngComm, 2002, 4,
378--392, doi [[https://pubs.rsc.org/en/content/articlelanding/2002/ce/b203191b#!divAbstract][10.1039/B203191B]].

[fn:2]  a) "A novel definition of a molecule in a crystal", Spackman,
M. A.; Byrom, P. G. in Chem. Phys. Lett., 1997, 267, 215--220, doi
[[https://www.sciencedirect.com/science/article/pii/S0009261497001000?via%3Dihub][10.1016/S0009-2614(97)00100-0]]. b) "Novel tools for visualizing and
exploring intermolecular interactions in molecular crystals",
McKinnon, J. J.; Spackman, M. A.; Mitchell, A. S. in Acta Cryst. B,
2004, 60, 627-- 668, doi [[http://scripts.iucr.org/cgi-bin/paper?S0108768104020300][10.1107/S0108768104020300]]. c)
http://130.95.176.70/wiki/index.php/The_Hirshfeld_Surface

[fn:1] http://crystalexplorer.scb.uwa.edu.au/

# END
